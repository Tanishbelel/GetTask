<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Student Task Management System - Firebase</title>



    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .auth-container,
        .loading-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
            color: rgb(255, 255, 255);
        }

        .auth-header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .auth-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }

        .tab-button {
            padding: 12px 30px;
            border: 2px solid white;
            background-color: transparent;
            color: white;
            cursor: pointer;
            border-radius: 25px 25px 0 0;
            margin-right: 5px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            background-color: white;
            color: #667eea;
        }

        .auth-form {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #363636;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .auth-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: transform 0.3s ease;
        }

        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #ddd;
        }

        .divider span {
            background: white;
            padding: 0 15px;
            color: #666;
        }

        .google-button {
            width: 100%;
            padding: 12px 30px;
            background: white;
            color: #333;
            border: 2px solid #ddd;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .google-button:hover {
            border-color: #4285f4;
            box-shadow: 0 2px 10px rgba(66, 133, 244, 0.2);
        }

        .google-icon {
            font-size: 18px;
        }

        .loading-content {
            text-align: center;
            color: white;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: rgb(254, 254, 254);
            min-height: 100vh;
        }

        .timer-container {
            background: linear-gradient(135deg, #ff4757 0%, #ff6b7a 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(255, 71, 87, 0.3);
            border: 2px solid #ff4757;
        }

        .timer-title {
            font-size: 1.5em;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .timer-display {
            font-size: 3em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            margin-bottom: 10px;
        }

        .timer-subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        .header h1 {
            color: #333;
            font-size: 2em;
        }

        .header-controls {
            display: flex;
            gap: 10px;
        }

        .refresh-button {
            background-color: #28a745;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .logout-button {
            background-color: #dc3545;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .student-info {
            background: linear-gradient(135deg, #f8fff8 0%, #e8f5e8 100%);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #28a745;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .student-info h3 {
            color: #2d5a3d;
            margin-bottom: 15px;
        }

        .student-info p {
            margin-bottom: 8px;
            font-size: 16px;
        }

        .progress-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .progress-card {
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #667eea;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .progress-card:hover {
            transform: translateY(-5px);
        }

        .progress-card h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .progress-card .number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }

        .week {
            margin: 25px 0;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .week.unlocked {
            border: 2px solid #28a745;
            background: linear-gradient(135deg, #f8fff8 0%, #ffffff 100%);
        }

        .week.locked {
            border: 2px solid #ccc;
            background: linear-gradient(135deg, #f5f5f5 0%, #e9ecef 100%);
            opacity: 0.7;
        }

        .week h3 {
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .form-container {
            margin: 15px 0;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e1e5e9;
            transition: all 0.3s ease;
        }

        .form-container.submitted {
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
            border-color: #28a745;
        }

        .form-container iframe {
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .submit-button {
            margin-top: 15px;
            padding: 12px 25px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .submit-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .admin-panel {
            margin-top: 40px;
            padding: 25px;
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border-radius: 15px;
            border: 2px solid #ffc107;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .admin-title {
            color: #856404;
            margin-bottom: 15px;
        }

        .activity-item {
            margin: 10px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            border-left: 4px solid #ffc107;
        }

        .verification-pending {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #ffc107;
            padding: 25px;
            border-radius: 15px;
            margin: 10px 0;
            text-align: center;
        }

        .message {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.3s ease;
        }

        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .success-message {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .timer-expired {
            animation: pulse 2s infinite;
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .progress-overview {
                grid-template-columns: repeat(2, 1fr);
            }

            .auth-container {
                padding: 10px;
            }

            .auth-form {
                padding: 20px;
            }

            .timer-display {
                font-size: 2.5em;
            }
        }
    </style>




    <!-- Firebase v9 SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, query, where, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js';

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAIv-W3l9MRg5CX_m3DVY7rKOe1Li48tbI",
            authDomain: "tasks-6b1aa.firebaseapp.com",
            projectId: "tasks-6b1aa",
            storageBucket: "tasks-6b1aa.firebasestorage.app",
            messagingSenderId: "12405651960",
            appId: "1:12405651960:web:6a9d75d065c6514d4f3e0d",
            measurementId: "G-64M4WBG4H7"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const analytics = getAnalytics(app);
        const googleProvider = new GoogleAuthProvider();

        // Make Firebase available globally
        window.db = db;
        window.auth = auth;
        window.googleProvider = googleProvider;
        window.firestore = { collection, doc, setDoc, getDoc, getDocs, updateDoc, query, where, onSnapshot };
        window.authMethods = { createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInWithPopup };
    </script>
</head>

<body>
    <!-- Login/Signup Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-header">
            <h1>üìö Student Task Management System</h1>
            <h2>Welcome! Please Login or Sign Up</h2>
        </div>

        <div class="auth-tabs">
            <button id="loginTab" class="tab-button active" onclick="taskSystem.showLoginForm()">Login</button>
            <button id="signupTab" class="tab-button" onclick="taskSystem.showSignupForm()">Sign Up</button>
        </div>

        <!-- Login Form -->
        <div id="loginForm" class="auth-form">
            <h3>üîë Student Login</h3>
            <form onsubmit="taskSystem.handleLogin(event)">
                <div class="form-group">
                    <label for="loginEmail">Email:</label>
                    <input type="email" id="loginEmail" required placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password:</label>
                    <input type="password" id="loginPassword" required placeholder="Enter your password">
                </div>
                <button type="submit" class="auth-button">Login</button>
            </form>

            <div class="divider"><span>OR</span></div>

            <button onclick="taskSystem.handleGoogleLogin()" class="google-button">
                <span class="google-icon">üîç</span>
                Sign in with Google
            </button>
        </div>

        <!-- Signup Form -->
        <div id="signupForm" class="auth-form" style="display: none;">
            <h3>üìù Student Registration</h3>
            <form onsubmit="taskSystem.handleSignup(event)">
                <div class="form-group">
                    <label for="signupName">Full Name:</label>
                    <input type="text" id="signupName" required placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label for="signupEmail">Email:</label>
                    <input type="email" id="signupEmail" required placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="signupPassword">Password:</label>
                    <input type="password" id="signupPassword" required
                        placeholder="Enter a password (min 6 characters)">
                </div>
                <button type="submit" class="auth-button">Sign Up</button>
            </form>

            <div class="divider">
                <span>OR</span>
            </div>

            <button onclick="taskSystem.handleGoogleSignup()" class="google-button">
                <span class="google-icon">üîç</span>
                Sign up with Google
            </button>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-container" style="display: none;">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>Loading your dashboard...</p>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="mainDashboard" class="container" style="display: none;">
        <!-- Timer Section -->
        <div id="timerContainer" class="timer-container">
            <div class="timer-title">‚è∞ Task Deadline Timer</div>
            <div id="timerDisplay" class="timer-display">06:00:00</div>
            <div class="timer-subtitle">Time remaining to complete all tasks</div>
        </div>

        <div class="header">
            <h1>üìö Student Task Management System</h1>
            <div class="header-controls">
                <button id="refreshBtn" onclick="taskSystem.refreshData()" class="refresh-button">üîÑ Refresh</button>
                <button id="logoutBtn" onclick="taskSystem.logout()" class="logout-button">Logout</button>
            </div>
        </div>

        <div class="student-info">
            <h3>üë®‚Äçüéì Student Dashboard</h3>
            <p><strong>Name:</strong> <span id="studentName">-</span></p>
            <p><strong>Email:</strong> <span id="studentEmail">-</span></p>
            <p><strong>Student ID:</strong> <span id="studentId">-</span></p>
            <p><strong>Status:</strong> <span id="verificationStatus">Verified ‚úÖ</span></p>
        </div>

        <div class="progress-overview">
            <div class="progress-card">
                <h3>Total Weeks</h3>
                <div class="number" id="totalWeeks">4</div>
            </div>
            <div class="progress-card">
                <h3>Completed Weeks</h3>
                <div class="number" id="completedWeeks">0</div>
            </div>
            <div class="progress-card">
                <h3>Current Week</h3>
                <div class="number" id="currentWeek">1</div>
            </div>
            <div class="progress-card">
                <h3>Overall Progress</h3>
                <div class="number" id="overallProgress">0%</div>
            </div>
        </div>

        <div class="weeks-container" id="weeksContainer">
            <!-- Weeks will be dynamically generated -->
        </div>

        <div class="admin-panel">
            <h3 class="admin-title">üîß Admin Panel - Recent Activity</h3>
            <div class="activity-log" id="activityLog">
                <p style="color: #666; font-style: italic;">Loading recent activity...</p>
            </div>
        </div>
    </div>

    <!-- Error/Success Messages -->
    <div id="messageContainer"
        style="position: fixed; border-radius: 10px; top: 20px; right: 20px; z-index: 1000; background: linear-gradient(135deg, #667eea 0%, #d0a1ff 100%)">
    </div>



    <script>
        class FirebaseTaskSystem {
            constructor() {
                this.totalWeeks = 4;
                this.currentUser = null;
                this.currentWeek = 1;
                this.completedWeeks = 0;
                this.weekData = this.initializeWeekData();
                this.timerDuration = 6 * 60 * 60; // 6 hours in seconds
                this.remainingTime = this.timerDuration;
                this.timerInterval = null;
                this.deadlineReached = false;
                this.init();
            }

            initializeWeekData() {
                return {
                    1: {
                        title: "Week 1: About my Students and AI Tools",
                        forms: [
                            { id: "form1_1", title: "Intoduction", url: "https://docs.google.com/forms/d/e/1FAIpQLScCVHCv1YYziSihEjBxz4GhUsRaJouAQ_hsjVykdsu5cK4sFw/viewform", submitted: false },
                            {
                                id: "form1_2",
                                title: "AI tools",
                                url: "https://docs.google.com/forms/d/e/1FAIpQLSep4shStZW8nnecpojqEQ0Oxef7q5wY5RL2DKR9PxEBOkhTxw/viewform",
                                submitted: false
                            }
                        ]
                    },
                    2: {
                        title: "Week 2: Power Bi and Github",
                        forms: [
                            { id: "form2_1", title: "All about Git and Github", url: "https://forms.gle/qnoWsxUtsivKQvBx6", submitted: false },
                            { id: "form2_2", title: "Power Bi", url: "https://forms.gle/HRaASjkm5CFC4xa88", submitted: false }
                        ]
                    },
                    3: {
                        title: "Python and its application",
                        forms: [
                            { id: "form3_1", title: "All about Python", url: "https://docs.google.com/forms/d/e/YOUR_FORM_ID_5/viewform", submitted: false },
                            { id: "form3_2", title: "ChatBot Using Python", url: "https://forms.gle/V9ZamjYGFaGwN71h6", submitted: false }
                        ]
                    },
                    4: {
                        title: "Week 4: Django and Final Project",
                        forms: [
                            { id: "form4_1", title: "All about Django", url: "https://forms.gle/gqzCemPxZPyKz9Q29", submitted: false },
                            { id: "form4_2", title: "Live Project", url: "https://forms.gle/nZ16pcPSVtV9zXxX8", submitted: false }
                        ]
                    }
                };
            }

            async init() {
                this.showLoading();
                await this.waitForFirebase();
                window.authMethods.onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        this.handleAuthenticatedUser(user);
                    } else {
                        this.showAuthScreen();
                    }
                });
            }

            waitForFirebase() {
                return new Promise((resolve) => {
                    const checkFirebase = () => {
                        if (window.db && window.auth) {
                            resolve();
                        } else {
                            setTimeout(checkFirebase, 100);
                        }
                    };
                    checkFirebase();
                });
            }

            showLoading() {
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('mainDashboard').style.display = 'none';
                document.getElementById('loadingScreen').style.display = 'flex';
            }

            showAuthScreen() {
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('authScreen').style.display = 'block';
                document.getElementById('mainDashboard').style.display = 'none';
                this.stopTimer();
            }

            showDashboard() {
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('mainDashboard').style.display = 'block';
                this.startTimer();
            }

            startTimer() {
                // Check if timer is already saved in user data
                if (this.currentUser && this.currentUser.timerStartTime) {
                    const elapsed = Math.floor((Date.now() - this.currentUser.timerStartTime) / 1000);
                    this.remainingTime = Math.max(0, this.timerDuration - elapsed);
                } else {
                    // First time login, save timer start time
                    const startTime = Date.now();
                    this.saveTimerStartTime(startTime);
                    this.remainingTime = this.timerDuration;
                }

                if (this.remainingTime <= 0) {
                    this.deadlineReached = true;
                    this.renderWeeks();
                }

                this.updateTimerDisplay();
                
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                }

                this.timerInterval = setInterval(() => {
                    this.remainingTime--;
                    this.updateTimerDisplay();
                    
                    if (this.remainingTime <= 0) {
                        this.deadlineReached = true;
                        this.renderWeeks();
                        clearInterval(this.timerInterval);
                        this.showError('Deadline reached! All tasks are now closed.');
                    }
                }, 1000);
            }

            stopTimer() {
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
            }

            async saveTimerStartTime(startTime) {
                try {
                    if (this.currentUser) {
                        await window.firestore.updateDoc(window.firestore.doc(window.db, 'users', this.currentUser.uid), {
                            timerStartTime: startTime
                        });
                        this.currentUser.timerStartTime = startTime;
                    }
                } catch (error) {
                    console.error('Error saving timer start time:', error);
                }
            }

            updateTimerDisplay() {
                const hours = Math.floor(this.remainingTime / 3600);
                const minutes = Math.floor((this.remainingTime % 3600) / 60);
                const seconds = this.remainingTime % 60;

                const formattedTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                const timerDisplay = document.getElementById('timerDisplay');
                const timerContainer = document.getElementById('timerContainer');
                
                if (timerDisplay) {
                    timerDisplay.textContent = formattedTime;
                }

                if (this.remainingTime <= 0) {
                    if (timerContainer) {
                        timerContainer.classList.add('timer-expired');
                        timerDisplay.textContent = '00:00:00';
                    }
                    const subtitle = document.querySelector('.timer-subtitle');
                    if (subtitle) {
                        subtitle.textContent = 'Deadline reached! All tasks are closed.';
                    }
                }
            }

            async handleAuthenticatedUser(user) {
                try {
                    const userDoc = await window.firestore.getDoc(window.firestore.doc(window.db, 'users', user.uid));

                    if (userDoc.exists()) {
                        this.currentUser = { ...userDoc.data(), uid: user.uid };
                        await this.loadUserData();
                        this.showDashboard();
                    } else {
                        this.showError('User not registered');
                        this.logout();
                    }
                } catch (error) {
                    console.error('Error loading user data:', error);
                    this.showError('Error loading user data: ' + error.message);
                }
            }

            showLoginForm() {
                document.getElementById('loginTab').classList.add('active');
                document.getElementById('signupTab').classList.remove('active');
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('signupForm').style.display = 'none';
            }

            showSignupForm() {
                document.getElementById('signupTab').classList.add('active');
                document.getElementById('loginTab').classList.remove('active');
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('signupForm').style.display = 'block';
            }

            async handleLogin(event) {
                event.preventDefault();
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;

                try {
                    this.showLoading();
                    await window.authMethods.signInWithEmailAndPassword(window.auth, email, password);
                } catch (error) {
                    this.showAuthScreen();
                    this.showError('Login failed: ' + error.message);
                }
            }

            async handleGoogleLogin() {
                try {
                    this.showLoading();
                    await window.authMethods.signInWithPopup(window.auth, window.googleProvider);
                } catch (error) {
                    this.showAuthScreen();
                    this.showError('Google login failed: ' + error.message);
                }
            }

            async handleSignup(event) {
                event.preventDefault();
                const name = document.getElementById('signupName').value.trim();
                const email = document.getElementById('signupEmail').value.trim();
                const password = document.getElementById('signupPassword').value;

                if (password.length < 6) {
                    this.showError('Password must be at least 6 characters long.');
                    return;
                }

                try {
                    this.showLoading();
                    const userCredential = await window.authMethods.createUserWithEmailAndPassword(window.auth, email, password);
                    await this.saveUserProfile(userCredential.user.uid, { name, email });
                    this.showSuccess('Registration successful! You can now access the course.');
                } catch (error) {
                    this.showAuthScreen();
                    this.showError('Registration failed: ' + error.message);
                }
            }

            async handleGoogleSignup() {
                try {
                    this.showLoading();
                    const result = await window.authMethods.signInWithPopup(window.auth, window.googleProvider);

                    const userDoc = await window.firestore.getDoc(window.firestore.doc(window.db, 'users', result.user.uid));

                    if (userDoc.exists()) {
                        return;
                    }

                    const name = result.user.displayName || 'Google User';
                    const email = result.user.email || '';

                    await this.saveUserProfile(result.user.uid, { name, email });
                    this.showSuccess('Google registration successful! You can now access the course.');

                } catch (error) {
                    this.showAuthScreen();
                    if (error.code === 'auth/popup-closed-by-user') {
                        this.showError('Sign-up cancelled.');
                    } else {
                        this.showError('Google registration failed: ' + error.message);
                    }
                }
            }

            async saveUserProfile(uid, profileData) {
                try {
                    const userData = {
                        ...profileData,
                        verified: true,
                        currentWeek: 1,
                        completedWeeks: 0,
                        course: 'Web Development Fundamentals',
                        createdAt: new Date().toISOString(),
                        timerStartTime: Date.now(),
                        progress: this.initializeProgress()
                    };

                    await window.firestore.setDoc(window.firestore.doc(window.db, 'users', uid), userData);
                    await this.logActivity(uid, 'User registered', `New user: ${profileData.name}`);
                } catch (error) {
                    console.error('Error saving user profile:', error);
                    throw error;
                }
            }

            initializeProgress() {
                const progress = {};
                for (let week = 1; week <= this.totalWeeks; week++) {
                    progress[week] = {};
                    this.weekData[week].forms.forEach(form => {
                        progress[week][form.id] = { submitted: false, submittedAt: null };
                    });
                }
                return progress;
            }

            async loadUserData() {
                try {
                    // Safely update elements
                    this.safeSetText('studentName', this.currentUser.name || 'N/A');
                    this.safeSetText('studentEmail', this.currentUser.email || 'N/A');
                    this.safeSetText('studentId', this.currentUser.uid || 'N/A');

                    const verificationStatus = document.getElementById('verificationStatus');
                    if (verificationStatus) {
                        verificationStatus.textContent = 'Verified ‚úÖ';
                        verificationStatus.style.color = '#28a745';
                    }

                    this.currentWeek = this.currentUser.currentWeek || 1;
                    this.completedWeeks = this.currentUser.completedWeeks || 0;

                    this.updateProgressDisplay();

                    if (this.currentUser.progress) {
                        this.syncProgressData();
                    }

                    this.renderWeeks();
                    this.loadActivityLog();

                } catch (error) {
                    console.error('Error loading user data:', error);
                    this.showError('Error loading user data: ' + error.message);
                }
            }

            safeSetText(elementId, text) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = text;
                }
            }

            syncProgressData() {
                for (let week = 1; week <= this.totalWeeks; week++) {
                    if (this.currentUser.progress[week]) {
                        this.weekData[week].forms.forEach(form => {
                            if (this.currentUser.progress[week][form.id]) {
                                form.submitted = this.currentUser.progress[week][form.id].submitted;
                            }
                        });
                    }
                }
            }

            updateProgressDisplay() {
                this.safeSetText('totalWeeks', this.totalWeeks);
                this.safeSetText('completedWeeks', this.completedWeeks);
                this.safeSetText('currentWeek', this.currentWeek);

                const overallProgress = Math.round((this.completedWeeks / this.totalWeeks) * 100);
                this.safeSetText('overallProgress', overallProgress + '%');
            }

            renderWeeks() {
                const container = document.getElementById('weeksContainer');
                if (!container) return;

                container.innerHTML = '';

                for (let weekNum = 1; weekNum <= this.totalWeeks; weekNum++) {
                    const week = this.weekData[weekNum];
                    const isUnlocked = weekNum <= this.currentWeek;

                    const weekElement = document.createElement('div');
                    weekElement.className = `week ${isUnlocked ? 'unlocked' : 'locked'}`;

                    let weekHtml = `<h3>${week.title}</h3>`;

                    if (isUnlocked) {
                        week.forms.forEach((form, formIndex) => {
                            const isSubmitted = form.submitted;
                            
                            // Check if deadline has been reached
                            if (this.deadlineReached) {
                                weekHtml += `
                                    <div class="form-container">
                                        <h4>${form.title}</h4>
                                        <div class="End-of-task" style="margin: 15px 0; height: 400px; width: 100%;
                     text-align: center; background: lightgreen; padding: 20px; border-radius: 10px; border: 1px solid green; align-content: center; color: red; font-size: 30px; font-weight: bold;">
                                            Task DeadLine Reached!
                                            <br/> <br/>
                                            Thank You for applying in this skill training internship.
                                        </div>
                                    </div>
                                `;
                            }
                            // Special handling for Week 2, Form 1 (index 0) when deadline not reached
                            else if (weekNum === 2 && formIndex === 0) {
                                weekHtml += `
                                    <div class="form-container ${isSubmitted ? 'submitted' : ''}">
                                        <h4>${form.title} ${isSubmitted ? '‚úÖ' : ''}</h4>
                                        <p style="margin: 10px 0; color: #666; font-style: italic;">
                                            ‚ö†Ô∏è Important: You must actually submit this Google Form to unlock the next week.
                                            Simply clicking "Mark as Submitted" will not unlock new content.
                                        </p>
                                        <h4 style="color: red; margin: 10px 0; font-style: italic;">
                                            NOTE: Use the same gmail in the google form from which you are logged in.
                                        </h4>
                                        
                                        <!-- Direct Form Access Button -->
                                        <div style="margin: 15px 0; text-align: center;">
                                            <button 
                                                onclick="window.open('${form.url}', '_blank')" 
                                                style="
                                                    background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
                                                    color: white;
                                                    padding: 12px 25px;
                                                    border: none;
                                                    border-radius: 25px;
                                                    cursor: pointer;
                                                    font-size: 16px;
                                                    font-weight: 600;
                                                    transition: all 0.3s ease;
                                                    box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
                                                "
                                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(66, 133, 244, 0.4)'"
                                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(66, 133, 244, 0.3)'"
                                            >
                                                üîó Open Google Form in New Tab
                                            </button>
                                        </div>

                                        ${form.submitted && form.uploadInfo ? `
                                            <div class="uploaded-file-info" style="margin-top: 10px;">
                                                <p><strong>Uploaded:</strong> ${form.uploadInfo.fileName}</p>
                                                <p><strong>Stored at:</strong> <a href="${form.uploadInfo.filePath}" target="_blank">${form.uploadInfo.filePath}</a></p>
                                            </div>
                                        ` : ''}

                                        <div style="margin-top: 15px;">
                                            <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                                                After submitting the form, click the button below to check if it was properly submitted:
                                            </p>
                                            <button class="submit-button"
                                                    onclick="taskSystem.checkFormSubmission(${weekNum}, '${form.id}')"
                                                    ${isSubmitted ? 'disabled' : ''}>
                                                ${isSubmitted ? 'Form Submitted ‚úÖ' : 'Check Form Submission'}
                                            </button>
                                        </div>
                                    </div>
                                `;
                            } 
                            // Special handling for Week 3, Form 1 (index 0) when deadline not reached
                            else if (weekNum === 3 && formIndex === 0) {
                                weekHtml += `
                                    <div class="form-container ${isSubmitted ? 'submitted' : ''}">
                                        <h4>${form.title} ${isSubmitted ? '‚úÖ' : ''}</h4>
                                        
                                        <!-- Direct Form Access Button -->
                                        <div class="End-of-task" style="margin: 15px 0; height: 300px; width: 100%;
                         text-align: center; background: #DEFFD0; padding: 20px; border-radius: 10px; border: 1px solid green; align-content: center; color: green; font-size: 30px; font-weight: bold;">
                                            Hurrayyyy!!! There's no task for this lecture.
                                            <br/> <br/>
                                           Just click on Check Form Submission button below and go ahead.
                                        </div>

                                        ${form.submitted && form.uploadInfo ? `
                                            <div class="uploaded-file-info" style="margin-top: 10px;">
                                                <p><strong>Uploaded:</strong> ${form.uploadInfo.fileName}</p>
                                                <p><strong>Stored at:</strong> <a href="${form.uploadInfo.filePath}" target="_blank">${form.uploadInfo.filePath}</a></p>
                                            </div>
                                        ` : ''}

                                        <div style="margin-top: 15px;">
                                            <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                                                After submitting the form, click the button below to check if it was properly submitted:
                                            </p>
                                            <button class="submit-button"
                                                    onclick="taskSystem.checkFormSubmission(${weekNum}, '${form.id}')"
                                                    ${isSubmitted ? 'disabled' : ''}>
                                                ${isSubmitted ? 'Form Submitted ‚úÖ' : 'Check Form Submission'}
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }
                            else {
                                // Regular form rendering for all other forms when deadline not reached
                                weekHtml += `
                                    <div class="form-container ${isSubmitted ? 'submitted' : ''}">
                                        <h4>${form.title} ${isSubmitted ? '‚úÖ' : ''}</h4>
                                        <p style="margin: 10px 0; color: #666; font-style: italic;">
                                            ‚ö†Ô∏è Important: You must actually submit this Google Form to unlock the next week.
                                            Simply clicking "Mark as Submitted" will not unlock new content.
                                        </p>
                                        <h4 style="color: red; margin: 10px 0; font-style: italic;">
                                            NOTE: Use the same gmail in the google form from which you are logged in.
                                        </h4>
                                        
                                        <iframe src="${form.url}?embedded=true"
                                                width="100%" height="400" frameborder="0">
                                            Loading form...
                                        </iframe>

                                        ${form.submitted && form.uploadInfo ? `
                                            <div class="uploaded-file-info" style="margin-top: 10px;">
                                                <p><strong>Uploaded:</strong> ${form.uploadInfo.fileName}</p>
                                                <p><strong>Stored at:</strong> <a href="${form.uploadInfo.filePath}" target="_blank">${form.uploadInfo.filePath}</a></p>
                                            </div>
                                        ` : ''}

                                        <div style="margin-top: 15px;">
                                            <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                                                After submitting the form above, click the button below to check if it was properly submitted:
                                            </p>
                                            <button class="submit-button"
                                                    onclick="taskSystem.checkFormSubmission(${weekNum}, '${form.id}')"
                                                    ${isSubmitted ? 'disabled' : ''}>
                                                ${isSubmitted ? 'Form Submitted ‚úÖ' : 'Check Form Submission'}
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }
                        });
                    } 
                    else {
                        // Week is locked
                        weekHtml += `
                            <div class="verification-pending">
                                <h4>üîí This week is locked</h4>
                                <p>Complete the previous week to unlock this content.</p>
                            </div>
                        `;
                    }

                    weekElement.innerHTML = weekHtml;
                    container.appendChild(weekElement);
                }

                // Make sure to bind the upload events after DOM is built
                this.bindUploadEvents();
            }

            bindUploadEvents() {
                const forms = document.querySelectorAll('.uploadForm');
                forms.forEach(form => {
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const status = form.querySelector('.upload-status');
                        status.innerText = 'Uploading...';

                        const formData = new FormData(form);
                        const email = form.querySelector('input[name="studentEmail"]').value;

                        try {
                            const response = await fetch('http://localhost:3001/upload', {
                                method: 'POST',
                                body: formData
                            });

                            const result = await response.json();

                            if (result.success) {
                                status.innerText = '‚úÖ Uploaded & logged to sheet!';
                                this.showSuccess('Upload successful!');
                            } else {
                                throw new Error('Upload failed on backend.');
                            }
                        } catch (err) {
                            console.error(err);
                            status.innerText = '‚ùå Upload failed.';
                            this.showError('Upload failed. Try again.');
                        }
                    });
                });
            }

            async checkFormSubmission(weekNum, formId) {
                try {
                    // Check if deadline has been reached
                    if (this.deadlineReached) {
                        this.showError('Deadline has been reached. No more submissions are allowed.');
                        return;
                    }

                    // Show loading state
                    const button = event.target;
                    const originalText = button.textContent;
                    button.textContent = 'Checking...';
                    button.disabled = true;

                    const isActuallySubmitted = await this.verifyFormSubmission(formId);

                    if (isActuallySubmitted) {
                        await this.submitForm(weekNum, formId);
                        button.textContent = 'Form Submitted ‚úÖ';
                        button.disabled = true;
                    } else {
                        button.textContent = originalText;
                        button.disabled = false;
                        this.showError('Form submission not detected. Please make sure you have submitted the Google Form above before clicking this button.');
                    }

                } catch (error) {
                    console.error('Error checking form submission:', error);
                    this.showError('Error checking form submission: ' + error.message);
                    // Reset button state
                    event.target.textContent = 'Check Form Submission';
                    event.target.disabled = false;
                }
            }

            async verifyFormSubmission(formId) {
                return new Promise((resolve) => {
                    const userConfirmation = confirm(
                        'Have you actually submitted the Google Form above?\n\n' +
                        'IMPORTANT: Only click "OK" if you have genuinely submitted the form. ' +
                        'False confirmations may result in your progress being reset.\n\n' +
                        'Click "OK" if you have submitted the form, or "Cancel" if you have not.'
                    );

                    // Add a small delay to simulate checking
                    setTimeout(() => {
                        resolve(userConfirmation);
                    }, 1000);
                });
            }

            async submitForm(weekNum, formId) {
                try {
                    const form = this.weekData[weekNum].forms.find(f => f.id === formId);
                    if (!form) return;

                    form.submitted = true;

                    const progressUpdate = {
                        [`progress.${weekNum}.${formId}.submitted`]: true,
                        [`progress.${weekNum}.${formId}.submittedAt`]: new Date().toISOString()
                    };

                    await window.firestore.updateDoc(window.firestore.doc(window.db, 'users', this.currentUser.uid), progressUpdate);

                    const weekForms = this.weekData[weekNum].forms;
                    const allSubmitted = weekForms.every(f => f.submitted);

                    if (allSubmitted && weekNum === this.currentWeek) {
                        this.completedWeeks++;
                        this.currentWeek = Math.min(this.currentWeek + 1, this.totalWeeks);

                        await window.firestore.updateDoc(window.firestore.doc(window.db, 'users', this.currentUser.uid), {
                            completedWeeks: this.completedWeeks,
                            currentWeek: this.currentWeek
                        });

                        this.showSuccess(`Week ${weekNum} completed! Week ${this.currentWeek} unlocked.`);
                    } else {
                        this.showSuccess('Form submission verified successfully!');
                    }

                    await this.logActivity(this.currentUser.uid, 'Form submitted', `${form.title} - Week ${weekNum}`);

                    this.updateProgressDisplay();
                    this.renderWeeks();

                } catch (error) {
                    console.error('Error processing form submission:', error);
                    this.showError('Error processing form submission: ' + error.message);
                }
            }

            async logActivity(userId, action, details) {
                try {
                    const activityData = {
                        userId,
                        userEmail: this.currentUser?.email || 'Unknown',
                        userName: this.currentUser?.name || 'Unknown',
                        action,
                        details,
                        timestamp: new Date().toISOString()
                    };

                    await window.firestore.setDoc(window.firestore.doc(window.db, 'activities', Date.now().toString()), activityData);
                } catch (error) {
                    console.error('Error logging activity:', error);
                }
            }

            async loadActivityLog() {
                try {
                    const activitiesQuery = window.firestore.query(
                        window.firestore.collection(window.db, 'activities'),
                        window.firestore.where('userId', '==', this.currentUser.uid)
                    );

                    const querySnapshot = await window.firestore.getDocs(activitiesQuery);
                    const activities = [];

                    querySnapshot.forEach((doc) => {
                        activities.push(doc.data());
                    });

                    activities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                    const activityLog = document.getElementById('activityLog');
                    if (activityLog) {
                        if (activities.length === 0) {
                            activityLog.innerHTML = '<p style="color: #666; font-style: italic;">No recent activity found.</p>';
                        } else {
                            activityLog.innerHTML = activities.slice(0, 10).map(activity => `
                                <div class="activity-item">
                                    <strong>${activity.action}</strong><br>
                                    ${activity.details}<br>
                                    <small style="color: #666;">${new Date(activity.timestamp).toLocaleString()}</small>
                                </div>
                            `).join('');
                        }
                    }

                } catch (error) {
                    console.error('Error loading activity log:', error);
                    const activityLog = document.getElementById('activityLog');
                    if (activityLog) {
                        activityLog.innerHTML = '<p style="color: #dc3545; background-color: red;">Error loading activity log.</p>';
                    }
                }
            }

            async refreshData() {
                try {
                    this.showLoading();

                    const userDoc = await window.firestore.getDoc(window.firestore.doc(window.db, 'users', this.currentUser.uid));

                    if (userDoc.exists()) {
                        this.currentUser = { ...userDoc.data(), uid: this.currentUser.uid };
                        await this.loadUserData();
                        this.showSuccess('Data refreshed successfully!');
                    }

                    this.showDashboard();

                } catch (error) {
                    console.error('Error refreshing data:', error);
                    this.showError('Error refreshing data: ' + error.message);
                    this.showDashboard();
                }
            }

            async logout() {
                try {
                    this.stopTimer();
                    await window.authMethods.signOut(window.auth);
                    this.currentUser = null;
                    this.showAuthScreen();
                } catch (error) {
                    console.error('Logout error:', error);
                    this.showError('Logout failed: ' + error.message);
                }
            }

            showError(message) {
                this.showMessage(message, 'error');
            }

            showSuccess(message) {
                this.showMessage(message, 'success');
            }

            showMessage(message, type) {
                const container = document.getElementById('messageContainer');
                if (!container) return;

                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}-message`;
                messageDiv.textContent = message;

                container.appendChild(messageDiv);

                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 5000);
            }
        }

        // Initialize the system when page loads
        window.taskSystem = new FirebaseTaskSystem();
    </script>
</body>

</html>
